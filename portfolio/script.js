const I18N = {
  en: {
    langCode: 'en',
    pageTitle: 'Jassem Younsi | Full Stack Developer',
    metaDescription: 'Jassem Younsi - Full Stack Developer & Cybersecurity Student. Spring Boot, Angular, AI/NLP.',
    nav: ['About', 'Now', 'Skills', 'Experience', 'Projects', 'Contact'],
    resume: 'Resume',
    heroBadge: 'Full Stack Developer · HITsolutions',
    heroLineTop: 'Building',
    heroLineBottom: 'solutions',
    heroDesc: "Spring Boot & Angular developer · AI/NLP enthusiast · Cybersecurity Master's student",
    heroButtons: ['View work', 'Get in touch'],
    codeWindowTitle: 'security-monitor.sh',
    codeSample: "const target = 'Full Stack';\nawait security.audit('HITsolutions');\n// Scanning for opportunities...\nif (skills.includes('NLP')) {\n  deploy.agent('Jassem');\n}",
    typedPhrases: ['full-stack', 'secure', 'intelligent', 'scalable'],
    loaderLines: [
      '<span class="term-accent">></span> Initializing system...',
      '<span class="term-accent">></span> Loading modules <span class="term-accent">[OK]</span>',
      '<span class="term-accent">></span> Establishing connection...',
      '<span class="term-accent">></span> Welcome to <span class="term-accent">Jassem\'s</span> portfolio.'
    ],
    sectionLabels: ['About', 'Now', 'Skills', 'Experience', 'Projects', 'Contact'],
    about: {
      intro1: "I'm a full stack developer at <strong>HITsolutions</strong>, specializing in Spring Boot and Angular. I hold a degree in Business Information Systems from ISG Tunis and I'm pursuing a <strong>Master's in Cybersecurity</strong>.",
      intro2: "I've built intelligent chatbot agents with NLP & LLMs, conference management systems, and startup platforms. I focus on clean architecture, security-first design, and delivering real impact.",
      location: 'Tunis, Tunisia',
      stat1: 'Years building',
      stat2: 'Lines of code'
    },
    now: {
      title: "What I'm up to",
      cards: [
        'Full stack development at <strong>HITsolutions</strong> — Spring Boot & Angular',
        "Pursuing my <strong>Master's in Cybersecurity</strong>",
        'Exploring penetration testing & secure coding practices'
      ]
    },
    skills: {
      title: 'Tech stack & tools',
      groups: ['Backend', 'Frontend', 'AI & Data', 'Security & DevOps']
    },
    experience: {
      title: 'Experience & Leadership',
      items: [
        {
          date: 'Aug 2025 – Present',
          role: 'Full Stack Developer',
          company: 'HITsolutions · Tunis',
          desc: 'Building scalable web apps with Spring Boot and Angular. RESTful APIs, agile sprints, startup environment.'
        },
        {
          date: 'Feb – May 2025',
          role: 'Software Developer Intern',
          company: 'HITsolutions · Tunis',
          desc: 'Developed an intelligent NLP chatbot for conversational database access. Intent detection, LLM integration, query execution.'
        },
        {
          date: '2024 – Present',
          role: 'SMA Junior Entreprise — IT Consultant',
          company: 'ISG Tunis · Student Association',
          desc: 'Junior IT Consultant and International Cell member (2024–2025), now Senior IT Consultant (2025–2026). Selected as chef de projet for specific projects and developed an AI recommendation system for the ISG job fair.'
        }
      ]
    },
    projects: {
      sectionTitle: 'Selected work',
      viewDetails: 'View details',
      data: {
        nlp: {
          title: 'NLP Chatbot Agent',
          cardDesc: 'Intelligent chatbot for natural language database queries. Intent detection, LLM integration, project management.',
          tags: 'NLP · LLM · Spring · Python',
          desc: 'Built an intelligent chatbot agent for conversational database access using natural language. Implemented intent detection and query execution systems for project and resource management. Integrated Large Language Models and deep learning techniques for improved user interaction. Enhanced data accessibility and decision-making through intelligent query processing.'
        },
        conference: {
          title: 'Conference Management',
          cardDesc: 'Java-based system with scheduling, registration, article submission, role-based auth.',
          tags: 'Java · JavaFX · MySQL · MVC',
          desc: 'Full Java-based conference management system with modules for scheduling, registration, and speaker management. Implemented role-based authentication for admins and committee members. Enabled article submission and scientific review workflows. Designed JavaFX interface with MySQL database integration.'
        },
        iot: {
          title: 'Smart Office IoT',
          cardDesc: 'IoT system with RFID access, fire detection, automated devices. Cisco Packet Tracer.',
          tags: 'IoT · Cisco · Simulation',
          desc: 'Designed a Smart Office IoT system with automated devices, secure RFID access, fire detection, and centralized network control. Simulated and tested in Cisco Packet Tracer for a connected, efficient workspace.'
        },
        investhub: {
          title: 'InvestHub',
          cardDesc: 'Platform connecting startups with investors. Profiles, projects, funding tracking.',
          tags: 'PHP · Bootstrap · MySQL',
          desc: 'Developed InvestHub platform for connecting startups with investors. User-friendly interface with startup profiles, projects, and investor engagement. Database management via phpMyAdmin. Project submissions, profile updates, and funding status tracking.'
        }
      }
    },
    contact: {
      title: "Let's connect",
      intro: "Open to opportunities in full stack development, AI/NLP, and cybersecurity. Drop a message—I'd love to connect.",
      copyHint: 'Click to copy',
      terminalTitle: 'guest@portfolio:~/messages',
      terminalCmd: './send-message --secure',
      nameLabel: 'Name:',
      emailLabel: 'Email:',
      namePlaceholder: 'Enter identity...',
      emailPlaceholder: 'Enter return address...',
      messagePlaceholder: '> Type payload...',
      submit: 'EXECUTE_TRANSMISSION',
      success: '> Packet transmitted successfully.',
      error: '> Transmission failed. Try again.'
    },
    footer: {
      copy: '© 2025 Jassem Younsi · Built with care',
      shortcutsPrefix: 'Press',
      shortcutsSuffix: 'for shortcuts'
    },
    shortcuts: {
      aria: 'Keyboard shortcuts',
      title: 'Keyboard shortcuts',
      toggleHelp: 'Toggle this help',
      closeModals: 'Close modals',
      jumpSection: 'Jump to section'
    },
    toasts: {
      emailCopied: 'Email copied!',
      phoneCopied: 'Phone copied!',
      copyFailed: 'Could not copy'
    },
    aria: {
      toggleMenu: 'Toggle menu',
      toggleTheme: 'Toggle theme',
      toggleThemeTitle: 'Toggle dark/light mode',
      backToTop: 'Back to top',
      closeModal: 'Close',
      projectDetails: 'View details',
      switchLanguage: 'Switch language',
      switchLanguageTitle: 'Passer en français'
    }
  },
  fr: {
    langCode: 'fr',
    pageTitle: 'Jassem Younsi | Développeur Full Stack',
    metaDescription: 'Jassem Younsi - Développeur Full Stack et étudiant en cybersécurité. Spring Boot, Angular, IA/NLP.',
    nav: ['À propos', 'Actu', 'Compétences', 'Expérience', 'Projets', 'Contact'],
    resume: 'CV',
    heroBadge: 'Développeur Full Stack · HITsolutions',
    heroLineTop: 'Créer des',
    heroLineBottom: 'solutions',
    heroDesc: 'Développeur Spring Boot & Angular · Passionné IA/NLP · Étudiant en Master Cybersécurité',
    heroButtons: ['Voir les projets', 'Me contacter'],
    codeWindowTitle: 'monitoring-securite.sh',
    codeSample: "const cible = 'Full Stack';\nawait securite.audit('HITsolutions');\n// Analyse des opportunités...\nif (competences.includes('NLP')) {\n  deployer.agent('Jassem');\n}",
    typedPhrases: ['robustes', 'sécurisées', 'intelligentes', 'scalables'],
    loaderLines: [
      '<span class="term-accent">></span> Initialisation du système...',
      '<span class="term-accent">></span> Chargement des modules <span class="term-accent">[OK]</span>',
      '<span class="term-accent">></span> Établissement de la connexion...',
      '<span class="term-accent">></span> Bienvenue sur le portfolio de <span class="term-accent">Jassem</span>.'
    ],
    sectionLabels: ['À propos', 'Actu', 'Compétences', 'Expérience', 'Projets', 'Contact'],
    about: {
      intro1: "Je suis développeur full stack chez <strong>HITsolutions</strong>, spécialisé en Spring Boot et Angular. Diplômé en Systèmes d'Information de Gestion à l'ISG Tunis, je poursuis actuellement un <strong>Master en Cybersécurité</strong>.",
      intro2: "J'ai conçu des agents chatbot intelligents avec NLP & LLMs, des systèmes de gestion de conférences et des plateformes pour startups. Je privilégie une architecture propre, la sécurité dès la conception et l'impact concret.",
      location: 'Tunis, Tunisie',
      stat1: "Années d'expérience",
      stat2: 'Lignes de code'
    },
    now: {
      title: 'Ce que je fais en ce moment',
      cards: [
        'Développement full stack chez <strong>HITsolutions</strong> — Spring Boot & Angular',
        'Poursuite de mon <strong>Master en Cybersécurité</strong>',
        'Exploration du pentest et des pratiques de développement sécurisé'
      ]
    },
    skills: {
      title: 'Stack technique & outils',
      groups: ['Backend', 'Frontend', 'IA & Données', 'Sécurité & DevOps']
    },
    experience: {
      title: 'Parcours & Leadership',
      items: [
        {
          date: 'Août 2025 – Aujourd\'hui',
          role: 'Développeur Full Stack',
          company: 'HITsolutions · Tunis',
          desc: 'Développement d’applications web scalables avec Spring Boot et Angular. APIs REST, sprints agiles, environnement startup.'
        },
        {
          date: 'Fév – Mai 2025',
          role: 'Stagiaire Développeur Logiciel',
          company: 'HITsolutions · Tunis',
          desc: 'Développement d’un chatbot NLP intelligent pour l’accès conversationnel aux bases de données. Détection d’intentions, intégration LLM, exécution de requêtes.'
        },
        {
          date: '2024 – Aujourd\'hui',
          role: 'SMA Junior Entreprise — Consultant IT',
          company: 'ISG Tunis · Association étudiante',
          desc: 'Junior IT Consultant et membre de la cellule internationale (2024–2025), puis Senior IT Consultant (2025–2026). Sélectionné comme chef de projet sur des projets spécifiques et développement d’un système de recommandation IA pour le job fair de l’ISG.'
        }
      ]
    },
    projects: {
      sectionTitle: 'Projets sélectionnés',
      viewDetails: 'Voir détails',
      data: {
        nlp: {
          title: 'Agent Chatbot NLP',
          cardDesc: 'Chatbot intelligent pour requêtes de base de données en langage naturel. Détection d’intentions, intégration LLM, gestion de projet.',
          tags: 'NLP · LLM · Spring · Python',
          desc: 'Création d’un agent chatbot intelligent pour l’accès conversationnel aux bases de données en langage naturel. Mise en place de la détection d’intentions et de systèmes d’exécution de requêtes pour la gestion des projets et ressources. Intégration de Large Language Models et de techniques de deep learning pour améliorer l’interaction utilisateur. Amélioration de l’accessibilité des données et de la prise de décision grâce à un traitement intelligent des requêtes.'
        },
        conference: {
          title: 'Gestion de Conférences',
          cardDesc: 'Système Java avec planification, inscriptions, soumission d’articles et authentification par rôles.',
          tags: 'Java · JavaFX · MySQL · MVC',
          desc: 'Système complet de gestion de conférences en Java avec modules de planification, inscription et gestion des intervenants. Authentification par rôles pour admins et membres du comité. Gestion des soumissions d’articles et des workflows de revue scientifique. Interface JavaFX avec intégration base de données MySQL.'
        },
        iot: {
          title: 'Smart Office IoT',
          cardDesc: 'Système IoT avec accès RFID, détection incendie et automatisation des appareils. Cisco Packet Tracer.',
          tags: 'IoT · Cisco · Simulation',
          desc: 'Conception d’un système IoT Smart Office avec appareils automatisés, accès RFID sécurisé, détection incendie et contrôle réseau centralisé. Simulation et tests réalisés sous Cisco Packet Tracer pour un espace de travail connecté et efficace.'
        },
        investhub: {
          title: 'InvestHub',
          cardDesc: 'Plateforme reliant startups et investisseurs. Profils, projets et suivi du financement.',
          tags: 'PHP · Bootstrap · MySQL',
          desc: 'Développement de la plateforme InvestHub pour connecter startups et investisseurs. Interface intuitive avec profils de startups, projets et interactions investisseurs. Gestion de base de données via phpMyAdmin. Soumission de projets, mise à jour des profils et suivi du financement.'
        }
      }
    },
    contact: {
      title: 'Restons en contact',
      intro: 'Ouvert aux opportunités en développement full stack, IA/NLP et cybersécurité. Envoyez-moi un message—je serai ravi d’échanger.',
      copyHint: 'Cliquer pour copier',
      terminalTitle: 'invite@portfolio:~/messages',
      terminalCmd: './envoyer-message --securise',
      nameLabel: 'Nom :',
      emailLabel: 'Email :',
      namePlaceholder: 'Entrez votre identité...',
      emailPlaceholder: 'Entrez votre adresse de retour...',
      messagePlaceholder: '> Saisir le message...',
      submit: 'EXECUTER_TRANSMISSION',
      success: '> Paquet transmis avec succès.',
      error: '> Échec de transmission. Réessayez.'
    },
    footer: {
      copy: '© 2025 Jassem Younsi · Réalisé avec soin',
      shortcutsPrefix: 'Appuyez sur',
      shortcutsSuffix: 'pour les raccourcis'
    },
    shortcuts: {
      aria: 'Raccourcis clavier',
      title: 'Raccourcis clavier',
      toggleHelp: 'Afficher/masquer cette aide',
      closeModals: 'Fermer les modales',
      jumpSection: 'Aller à une section'
    },
    toasts: {
      emailCopied: 'Email copié !',
      phoneCopied: 'Téléphone copié !',
      copyFailed: 'Copie impossible'
    },
    aria: {
      toggleMenu: 'Ouvrir le menu',
      toggleTheme: 'Basculer le thème',
      toggleThemeTitle: 'Basculer sombre/clair',
      backToTop: 'Retour en haut',
      closeModal: 'Fermer',
      projectDetails: 'Voir détails',
      switchLanguage: 'Changer la langue',
      switchLanguageTitle: 'Langue suivante'
    }
  },
  de: {
    langCode: 'de',
    pageTitle: 'Jassem Younsi | Full-Stack-Entwickler',
    metaDescription: 'Jassem Younsi - Full-Stack-Entwickler und Cybersicherheits-Student. Spring Boot, Angular, KI/NLP.',
    nav: ['Über mich', 'Aktuell', 'Skills', 'Erfahrung', 'Projekte', 'Kontakt'],
    resume: 'Lebenslauf',
    heroBadge: 'Full-Stack-Entwickler · HITsolutions',
    heroLineTop: 'Ich entwickle',
    heroLineBottom: 'Lösungen',
    heroDesc: 'Spring Boot & Angular Entwickler · KI/NLP Enthusiast · Masterstudent für Cybersicherheit',
    heroButtons: ['Projekte ansehen', 'Kontakt aufnehmen'],
    codeWindowTitle: 'sicherheits-monitor.sh',
    codeSample: "const ziel = 'Full Stack';\nawait sicherheit.audit('HITsolutions');\n// Suche nach Chancen...\nif (skills.includes('NLP')) {\n  deploy.agent('Jassem');\n}",
    typedPhrases: ['robuste', 'sichere', 'intelligente', 'skalierbare'],
    loaderLines: [
      '<span class="term-accent">></span> System wird initialisiert...',
      '<span class="term-accent">></span> Module werden geladen <span class="term-accent">[OK]</span>',
      '<span class="term-accent">></span> Verbindung wird hergestellt...',
      '<span class="term-accent">></span> Willkommen im Portfolio von <span class="term-accent">Jassem</span>.'
    ],
    sectionLabels: ['Über mich', 'Aktuell', 'Skills', 'Erfahrung', 'Projekte', 'Kontakt'],
    about: {
      intro1: 'Ich bin Full-Stack-Entwickler bei <strong>HITsolutions</strong> mit Schwerpunkt auf Spring Boot und Angular. Ich habe einen Abschluss in Business Information Systems von der ISG Tunis und absolviere derzeit einen <strong>Master in Cybersicherheit</strong>.',
      intro2: 'Ich habe intelligente Chatbot-Agenten mit NLP & LLMs, Konferenzmanagement-Systeme und Startup-Plattformen entwickelt. Mein Fokus liegt auf sauberer Architektur, Security-by-Design und messbarem Mehrwert.',
      location: 'Tunis, Tunesien',
      stat1: 'Jahre Entwicklung',
      stat2: 'Codezeilen'
    },
    now: {
      title: 'Woran ich gerade arbeite',
      cards: [
        'Full-Stack-Entwicklung bei <strong>HITsolutions</strong> — Spring Boot & Angular',
        'Masterstudium in <strong>Cybersicherheit</strong>',
        'Vertiefung in Penetration Testing und sichere Coding-Praktiken'
      ]
    },
    skills: {
      title: 'Tech-Stack & Werkzeuge',
      groups: ['Backend-Entwicklung', 'Frontend-Entwicklung', 'KI & Daten', 'Sicherheit & DevOps']
    },
    experience: {
      title: 'Erfahrung & Leadership',
      items: [
        {
          date: 'Aug 2025 – Heute',
          role: 'Full-Stack-Entwickler',
          company: 'HITsolutions · Tunis',
          desc: 'Entwicklung skalierbarer Webanwendungen mit Spring Boot und Angular. REST-APIs, agile Sprints, Startup-Umfeld.'
        },
        {
          date: 'Feb – Mai 2025',
          role: 'Praktikant Softwareentwicklung',
          company: 'HITsolutions · Tunis',
          desc: 'Entwicklung eines intelligenten NLP-Chatbots für den konversationellen Datenbankzugriff. Intent-Erkennung, LLM-Integration und Query-Ausführung.'
        },
        {
          date: '2024 – Heute',
          role: 'SMA Junior Entreprise — IT Consultant',
          company: 'ISG Tunis · Studierendenverein',
          desc: 'Junior IT Consultant und Mitglied der International Cell (2024–2025), jetzt Senior IT Consultant (2025–2026). Als Projektchef für spezifische Projekte ausgewählt und Entwicklung eines KI-Empfehlungssystems für die ISG-Jobmesse.'
        }
      ]
    },
    projects: {
      sectionTitle: 'Ausgewählte Projekte',
      viewDetails: 'Details ansehen',
      data: {
        nlp: {
          title: 'NLP-Chatbot-Agent',
          cardDesc: 'Intelligenter Chatbot für Datenbankabfragen in natürlicher Sprache. Intent-Erkennung, LLM-Integration, Projektmanagement.',
          tags: 'NLP · LLM · Spring · Python',
          desc: 'Entwicklung eines intelligenten Chatbot-Agenten für konversationellen Datenbankzugriff mit natürlicher Sprache. Implementierung von Intent-Erkennung und Query-Ausführung für Projekt- und Ressourcenmanagement. Integration von Large Language Models und Deep-Learning-Techniken zur Verbesserung der Nutzerinteraktion. Besserer Datenzugriff und fundiertere Entscheidungen durch intelligente Anfrageverarbeitung.'
        },
        conference: {
          title: 'Konferenzmanagement',
          cardDesc: 'Java-basiertes System mit Planung, Registrierung, Artikel-Einreichung und rollenbasierter Authentifizierung.',
          tags: 'Java · JavaFX · MySQL · MVC',
          desc: 'Vollständiges Java-basiertes Konferenzmanagement-System mit Modulen für Planung, Registrierung und Speaker-Management. Rollenbasierte Authentifizierung für Admins und Komiteemitglieder. Unterstützung für Artikel-Einreichung und wissenschaftliche Review-Workflows. JavaFX-Oberfläche mit MySQL-Integration.'
        },
        iot: {
          title: 'Smart Office IoT',
          cardDesc: 'IoT-System mit RFID-Zugang, Branderkennung und automatisierten Geräten. Cisco Packet Tracer.',
          tags: 'IoT · Cisco · Simulation',
          desc: 'Konzeption eines Smart-Office-IoT-Systems mit automatisierten Geräten, sicherem RFID-Zugang, Branderkennung und zentraler Netzwerksteuerung. Simulation und Tests in Cisco Packet Tracer für einen vernetzten und effizienten Arbeitsplatz.'
        },
        investhub: {
          title: 'InvestHub',
          cardDesc: 'Plattform zur Verbindung von Startups und Investoren. Profile, Projekte und Finanzierungs-Tracking.',
          tags: 'PHP · Bootstrap · MySQL',
          desc: 'Entwicklung der InvestHub-Plattform zur Verbindung von Startups mit Investoren. Benutzerfreundliche Oberfläche mit Startup-Profilen, Projekten und Investor-Interaktion. Datenbankverwaltung über phpMyAdmin. Projekteinreichungen, Profilaktualisierungen und Tracking des Finanzierungsstatus.'
        }
      }
    },
    contact: {
      title: 'Lass uns vernetzen',
      intro: 'Ich bin offen für Möglichkeiten in Full-Stack-Entwicklung, KI/NLP und Cybersicherheit. Schreib mir gerne eine Nachricht.',
      copyHint: 'Klicken zum Kopieren',
      terminalTitle: 'gast@portfolio:~/nachrichten',
      terminalCmd: './nachricht-senden --sicher',
      nameLabel: 'Name:',
      emailLabel: 'E-Mail:',
      namePlaceholder: 'Identität eingeben...',
      emailPlaceholder: 'Antwortadresse eingeben...',
      messagePlaceholder: '> Nachricht eingeben...',
      submit: 'ÜBERTRAGUNG_STARTEN',
      success: '> Paket erfolgreich übertragen.',
      error: '> Übertragung fehlgeschlagen. Erneut versuchen.'
    },
    footer: {
      copy: '© 2025 Jassem Younsi · Mit Sorgfalt erstellt',
      shortcutsPrefix: 'Drücke',
      shortcutsSuffix: 'für Shortcuts'
    },
    shortcuts: {
      aria: 'Tastenkürzel',
      title: 'Tastenkürzel',
      toggleHelp: 'Diese Hilfe ein-/ausblenden',
      closeModals: 'Modale schließen',
      jumpSection: 'Zum Abschnitt springen'
    },
    toasts: {
      emailCopied: 'E-Mail kopiert!',
      phoneCopied: 'Telefonnummer kopiert!',
      copyFailed: 'Kopieren nicht möglich'
    },
    aria: {
      toggleMenu: 'Menü umschalten',
      toggleTheme: 'Theme wechseln',
      toggleThemeTitle: 'Hell/Dunkel wechseln',
      backToTop: 'Nach oben',
      closeModal: 'Schließen',
      projectDetails: 'Details ansehen',
      switchLanguage: 'Sprache wechseln',
      switchLanguageTitle: 'Nächste Sprache'
    }
  }
};

let currentLanguage = localStorage.getItem('language') || 'en';
if (!I18N[currentLanguage]) currentLanguage = 'en';
const LANGUAGE_ORDER = ['en', 'fr', 'de'];
const LANGUAGE_LABELS = { en: 'EN', fr: 'FR', de: 'DE' };
const LANGUAGE_DISPLAY = { en: 'English', fr: 'Français', de: 'Deutsch' };
const LANGUAGE_SWITCH_DURATION = 1050;
let languageCubeTimeoutId;
let languageSwitchTimeoutId;
let languageSwitchRafId;

function startLanguageSwitchAnimation() {
  document.body.classList.remove('lang-switching');

  clearTimeout(languageSwitchTimeoutId);
  if (languageSwitchRafId) {
    cancelAnimationFrame(languageSwitchRafId);
  }

  void document.body.offsetWidth;

  languageSwitchRafId = requestAnimationFrame(() => {
    document.body.classList.add('lang-switching');
    languageSwitchTimeoutId = setTimeout(() => {
      document.body.classList.remove('lang-switching');
      languageSwitchRafId = undefined;
    }, LANGUAGE_SWITCH_DURATION);
  });
}

function showLanguageSwitchCube(lang) {
  const label = LANGUAGE_DISPLAY[lang] || LANGUAGE_LABELS[lang] || 'EN';
  let cube = document.getElementById('language-switch-indicator');

  if (!cube) {
    cube = document.createElement('div');
    cube.id = 'language-switch-indicator';
    cube.className = 'language-switch-indicator';
    document.body.appendChild(cube);
  }

  cube.textContent = label;
  cube.classList.remove('show');
  void cube.offsetWidth;
  cube.classList.add('show');

  clearTimeout(languageCubeTimeoutId);
  languageCubeTimeoutId = setTimeout(() => {
    cube.classList.remove('show');
  }, LANGUAGE_SWITCH_DURATION);
}

if ('scrollRestoration' in history) {
  history.scrollRestoration = 'manual';
}
window.scrollTo(0, 0);

// ===== LOADING SCREEN =====
(function initLoader() {
  const loader = document.getElementById('loader');
  const bar    = document.getElementById('loader-bar');
  const svg    = document.querySelector('.loader-svg');
  const term   = document.getElementById('loader-terminal');
  const canvas = document.getElementById('loader-canvas');

  document.body.style.overflow = 'hidden';

  // --- Animated grid background on canvas ---
  const ctx = canvas?.getContext('2d');
  let animFrame;
  function resizeCanvas() {
    if (!canvas) return;
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  const style = getComputedStyle(document.documentElement);
  const accent = style.getPropertyValue('--accent').trim() || '#00d4aa';

  // Grid nodes
  const cols = 28, rows = 16;
  const nodes = [];
  function buildNodes() {
    nodes.length = 0;
    const cw = canvas.width, ch = canvas.height;
    const gx = cw / (cols - 1), gy = ch / (rows - 1);
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        nodes.push({
          x: c * gx, y: r * gy,
          ox: c * gx, oy: r * gy,
          pulse: Math.random() * Math.PI * 2
        });
      }
    }
  }
  buildNodes();
  window.addEventListener('resize', buildNodes);

  function drawGrid(t) {
    if (!ctx) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // update & draw nodes
    for (const n of nodes) {
      n.pulse += 0.02;
      const wave = Math.sin(n.pulse) * 1.5;
      n.x = n.ox + wave;
      n.y = n.oy + wave;
    }
    // draw connections
    ctx.strokeStyle = accent;
    ctx.lineWidth = 0.3;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const i = r * cols + c;
        const n = nodes[i];
        if (c < cols-1) {
          ctx.globalAlpha = 0.08 + Math.sin(n.pulse) * 0.04;
          ctx.beginPath(); ctx.moveTo(n.x, n.y);
          ctx.lineTo(nodes[i+1].x, nodes[i+1].y); ctx.stroke();
        }
        if (r < rows-1) {
          ctx.globalAlpha = 0.08 + Math.sin(n.pulse) * 0.04;
          ctx.beginPath(); ctx.moveTo(n.x, n.y);
          ctx.lineTo(nodes[i+cols].x, nodes[i+cols].y); ctx.stroke();
        }
      }
    }
    // draw dots
    for (const n of nodes) {
      const bright = 0.15 + Math.sin(n.pulse) * 0.1;
      ctx.globalAlpha = bright;
      ctx.fillStyle = accent;
      ctx.beginPath(); ctx.arc(n.x, n.y, 1.2, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1;
    animFrame = requestAnimationFrame(drawGrid);
  }
  animFrame = requestAnimationFrame(drawGrid);

  // --- Terminal boot lines ---
  const lines = I18N[currentLanguage].loaderLines;
  let lineIdx = 0;
  function addLine() {
    if (!term || lineIdx >= lines.length) return;
    const div = document.createElement('div');
    div.className = 'term-line';
    div.innerHTML = lines[lineIdx];
    term.appendChild(div);
    lineIdx++;
  }

  // --- Progress + sequencing ---
  let progress = 0;
  const totalDuration = 2800; // ms
  const startTime = performance.now();

  function tick() {
    const elapsed = performance.now() - startTime;
    progress = Math.min((elapsed / totalDuration) * 100, 100);
    if (bar) bar.style.width = progress + '%';

    // trigger terminal lines at thresholds
    if (progress >= 10 && lineIdx === 0) addLine();
    if (progress >= 35 && lineIdx === 1) addLine();
    if (progress >= 60 && lineIdx === 2) addLine();
    if (progress >= 90 && lineIdx === 3) addLine();

    // trigger glitch phase at 60%
    if (progress >= 60 && svg && !svg.classList.contains('drawn')) {
      svg.classList.add('drawn');
    }

    if (progress < 100) {
      requestAnimationFrame(tick);
    } else {
      setTimeout(finishLoader, 500);
    }
  }
  requestAnimationFrame(tick);

  function finishLoader() {
    cancelAnimationFrame(animFrame);
    loader?.classList.add('exit');
    setTimeout(() => {
      loader?.classList.add('hidden');
      document.body.style.overflow = '';
      window.scrollTo(0, 0);
    }, 850);
  }
})();

// Typewriter effect
let phrases = [...I18N[currentLanguage].typedPhrases];
let phraseIndex = 0;
let charIndex = 0;
let isDeleting = false;
const typedEl = document.getElementById('typed-text');

function type() {
  if (!typedEl) return;
  const current = phrases[phraseIndex];
  if (isDeleting) {
    typedEl.textContent = current.slice(0, charIndex - 1);
    charIndex--;
  } else {
    typedEl.textContent = current.slice(0, charIndex + 1);
    charIndex++;
  }
  let delay = isDeleting ? 50 : 80;
  if (!isDeleting && charIndex === current.length) {
    delay = 2000;
    isDeleting = true;
  } else if (isDeleting && charIndex === 0) {
    isDeleting = false;
    phraseIndex = (phraseIndex + 1) % phrases.length;
    delay = 400;
  }
  setTimeout(type, delay);
}
if (typedEl) setTimeout(type, 800);

let activeProjectId = null;

function renderProjectModal(projectId) {
  const projectModal = document.getElementById('project-modal');
  const modalContent = document.getElementById('modal-content');
  if (!projectModal || !modalContent) return;
  const p = I18N[currentLanguage]?.projects?.data?.[projectId];
  if (!p) return;
  modalContent.innerHTML = `
      <h3 id="modal-title">${p.title}</h3>
      <p class="modal-tags">${p.tags}</p>
      <p class="modal-desc">${p.desc}</p>
    `;
}

function setText(selector, value) {
  const element = document.querySelector(selector);
  if (element && typeof value === 'string') element.textContent = value;
}

function setHTML(selector, value) {
  const element = document.querySelector(selector);
  if (element && typeof value === 'string') element.innerHTML = value;
}

function setAttribute(selector, attr, value) {
  const element = document.querySelector(selector);
  if (element && typeof value === 'string') element.setAttribute(attr, value);
}

function applyLanguage(lang, { animate = true } = {}) {
  if (!I18N[lang]) return;
  const t = I18N[lang];

  if (animate) {
    showLanguageSwitchCube(lang);
    startLanguageSwitchAnimation();
  }

  currentLanguage = lang;
  localStorage.setItem('language', lang);
  document.documentElement.lang = t.langCode;
  document.title = t.pageTitle;

  const metaDescription = document.querySelector('meta[name="description"]');
  if (metaDescription) metaDescription.setAttribute('content', t.metaDescription);

  const navLinks = document.querySelectorAll('.nav-links a');
  navLinks.forEach((link, index) => {
    if (t.nav[index]) link.textContent = t.nav[index];
  });

  setText('.nav-cta', t.resume);
  setText('.hero-badge', t.heroBadge);

  const heroLines = document.querySelectorAll('.hero-title .hero-line');
  if (heroLines[0]) heroLines[0].textContent = t.heroLineTop;
  if (heroLines[2]) heroLines[2].textContent = t.heroLineBottom;

  setText('.hero-desc', t.heroDesc);

  const heroButtons = document.querySelectorAll('.hero-actions .btn');
  if (heroButtons[0]) heroButtons[0].textContent = t.heroButtons[0];
  if (heroButtons[1]) heroButtons[1].textContent = t.heroButtons[1];

  setText('.window-title', t.codeWindowTitle);

  const codeInput = document.getElementById('code-input');
  if (codeInput) {
    codeInput.value = t.codeSample;
    codeInput.dispatchEvent(new Event('input', { bubbles: true }));
  }

  const sectionLabels = document.querySelectorAll('.section-label');
  sectionLabels.forEach((label, index) => {
    if (t.sectionLabels[index]) label.textContent = t.sectionLabels[index];
  });

  setHTML('.about-content p:nth-of-type(1)', t.about.intro1);
  setHTML('.about-content p:nth-of-type(2)', t.about.intro2);

  const aboutLocation = document.querySelector('.about-location');
  if (aboutLocation) {
    const icon = aboutLocation.querySelector('.location-icon')?.cloneNode(true);
    aboutLocation.textContent = '';
    if (icon) aboutLocation.appendChild(icon);
    aboutLocation.append(` ${t.about.location}`);
  }

  setText('.about-visual .about-card:nth-child(1) span:last-child', t.about.stat1);
  setText('.about-visual .about-card:nth-child(2) span:last-child', t.about.stat2);

  setText('#now .section-title', t.now.title);
  const nowCards = document.querySelectorAll('.now-card p');
  nowCards.forEach((card, index) => {
    if (t.now.cards[index]) card.innerHTML = t.now.cards[index];
  });

  setText('#skills .section-title', t.skills.title);
  const skillGroups = document.querySelectorAll('.skill-group h3');
  skillGroups.forEach((group, index) => {
    if (t.skills.groups[index]) group.textContent = t.skills.groups[index];
  });

  setText('#experience .section-title', t.experience.title);
  const timelineItems = document.querySelectorAll('.timeline-item');
  timelineItems.forEach((item, index) => {
    const source = t.experience.items[index];
    if (!source) return;
    item.querySelector('.timeline-date').textContent = source.date;
    item.querySelector('h3').textContent = source.role;
    item.querySelector('.timeline-company').textContent = source.company;
    item.querySelector('p:last-child').textContent = source.desc;
  });

  setText('#projects .section-title', t.projects.sectionTitle);
  const projectCards = document.querySelectorAll('.project-card');
  projectCards.forEach((card) => {
    const id = card.dataset.project;
    const data = t.projects.data[id];
    if (!data) return;
    card.querySelector('h3').textContent = data.title;
    card.querySelector('.project-body p').textContent = data.cardDesc;
    const detailsButton = card.querySelector('.project-expand');
    detailsButton.textContent = t.projects.viewDetails;
    detailsButton.setAttribute('aria-label', t.aria.projectDetails);
  });

  setText('#contact .section-title', t.contact.title);
  setText('.contact-intro', t.contact.intro);

  const copyHints = document.querySelectorAll('.copy-hint');
  copyHints.forEach((hint) => {
    hint.textContent = t.contact.copyHint;
  });

  setText('.terminal-title', t.contact.terminalTitle);
  setText('.terminal-cmd', t.contact.terminalCmd);

  const formLabels = document.querySelectorAll('#contact-form .terminal-input-line span');
  if (formLabels[0]) formLabels[0].textContent = t.contact.nameLabel;
  if (formLabels[1]) formLabels[1].textContent = t.contact.emailLabel;

  setAttribute('#contact-form input[name="name"]', 'placeholder', t.contact.namePlaceholder);
  setAttribute('#contact-form input[name="email"]', 'placeholder', t.contact.emailPlaceholder);
  setAttribute('#contact-form textarea[name="message"]', 'placeholder', t.contact.messagePlaceholder);
  setText('#contact-form .terminal-btn', t.contact.submit);
  setText('#form-response', t.contact.success);
  setText('#form-error', t.contact.error);

  setText('.footer p', t.footer.copy);

  const footerShortcuts = document.querySelector('.footer-shortcuts');
  if (footerShortcuts) {
    footerShortcuts.innerHTML = `${t.footer.shortcutsPrefix} <kbd>?</kbd> ${t.footer.shortcutsSuffix}`;
  }

  setAttribute('#shortcuts-modal', 'aria-label', t.shortcuts.aria);
  setText('.shortcuts-content h3', t.shortcuts.title);

  const shortcutItems = document.querySelectorAll('.shortcuts-content li');
  if (shortcutItems[0]) shortcutItems[0].innerHTML = `<kbd>?</kbd> ${t.shortcuts.toggleHelp}`;
  if (shortcutItems[1]) shortcutItems[1].innerHTML = `<kbd>Esc</kbd> ${t.shortcuts.closeModals}`;
  if (shortcutItems[2]) shortcutItems[2].innerHTML = `<kbd>1</kbd>–<kbd>5</kbd> ${t.shortcuts.jumpSection}`;

  setAttribute('.nav-toggle', 'aria-label', t.aria.toggleMenu);
  setAttribute('.theme-toggle', 'aria-label', t.aria.toggleTheme);
  setAttribute('.theme-toggle', 'title', t.aria.toggleThemeTitle);
  setAttribute('.back-to-top', 'aria-label', t.aria.backToTop);
  setAttribute('.back-to-top', 'title', t.aria.backToTop);
  setAttribute('.modal-close', 'aria-label', t.aria.closeModal);

  const langToggle = document.getElementById('lang-toggle');
  if (langToggle) {
    const currentIndex = LANGUAGE_ORDER.indexOf(lang);
    const nextLanguage = LANGUAGE_ORDER[(currentIndex + 1) % LANGUAGE_ORDER.length];
    const currentLabel = LANGUAGE_LABELS[lang] || 'EN';
    const nextLabel = LANGUAGE_DISPLAY[nextLanguage] || LANGUAGE_LABELS[nextLanguage] || 'EN';
    langToggle.textContent = `LANG ${currentLabel}`;
    langToggle.setAttribute('aria-label', t.aria.switchLanguage);
    langToggle.setAttribute('title', `${t.aria.switchLanguageTitle}: ${nextLabel}`);
  }

  phrases = [...t.typedPhrases];
  phraseIndex = 0;
  charIndex = 0;
  isDeleting = false;
  if (typedEl) typedEl.textContent = '';

  if (activeProjectId) {
    renderProjectModal(activeProjectId);
  }
}

const langToggle = document.getElementById('lang-toggle');
langToggle?.addEventListener('click', () => {
  const currentIndex = LANGUAGE_ORDER.indexOf(currentLanguage);
  const nextLanguage = LANGUAGE_ORDER[(currentIndex + 1) % LANGUAGE_ORDER.length];
  applyLanguage(nextLanguage, { animate: true });
});

applyLanguage(currentLanguage, { animate: false });

// ===== INTERACTIVE CODE EDITOR =====
(function initCodeEditor() {
  const input     = document.getElementById('code-input');
  const highlight = document.getElementById('code-highlight');
  const lineNums  = document.getElementById('line-numbers');
  if (!input || !highlight || !lineNums) return;

  const keywords = ['const','let','var','if','else','for','while','return','function','await','async','class','new','import','export','from','true','false','null','undefined'];
  const kwRegex = new RegExp('\\b(' + keywords.join('|') + ')\\b', 'g');

  function highlightLine(raw) {
    let s = raw
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');

    // Comments
    const commentIdx = s.indexOf('//');
    if (commentIdx !== -1) {
      const before = s.slice(0, commentIdx);
      const comment = s.slice(commentIdx);
      return colorize(before) + '<span class="syn-comment">' + comment + '</span>';
    }
    return colorize(s);
  }

  function colorize(s) {
    // Strings
    s = s.replace(/('(?:[^'\\]|\\.)*'|"(?:[^"\\]|\\.)*")/g, '<span class="syn-string">$1</span>');
    // Numbers
    s = s.replace(/\b(\d+\.?\d*)\b/g, '<span class="syn-number">$1</span>');
    // Keywords
    s = s.replace(kwRegex, '<span class="syn-keyword">$1</span>');
    // Function calls
    s = s.replace(/\b([a-zA-Z_]\w*)(?=\s*\()/g, '<span class="syn-function">$1</span>');
    // Dot methods
    s = s.replace(/\.([a-zA-Z_]\w*)(?=\s*\()/g, '.<span class="syn-function">$1</span>');
    return s;
  }

  function render() {
    const text = input.value;
    const lines = text.split('\n');

    // Update highlight overlay — trailing \n keeps height parity with textarea
    highlight.innerHTML = lines.map(l => highlightLine(l)).join('\n') + '\n';

    // Update line numbers
    lineNums.textContent = lines.map((_, i) => i + 1).join('\n');
  }

  // Handle Tab key
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = input.selectionStart;
      const end = input.selectionEnd;
      input.value = input.value.substring(0, start) + '  ' + input.value.substring(end);
      input.selectionStart = input.selectionEnd = start + 2;
      render();
    }
  });

  // Sync scroll
  input.addEventListener('scroll', () => {
    highlight.scrollTop = input.scrollTop;
    highlight.scrollLeft = input.scrollLeft;
  });

  input.addEventListener('input', render);
  render();
})();

// Scroll progress bar
const scrollProgress = document.querySelector('.scroll-progress');
window.addEventListener('scroll', () => {
  if (scrollProgress) {
    const h = document.documentElement.scrollHeight - window.innerHeight;
    scrollProgress.style.width = (window.scrollY / h) * 100 + '%';
  }
});

// Theme toggle
const themeToggle = document.querySelector('.theme-toggle');
const html = document.documentElement;
const savedTheme = localStorage.getItem('theme') || 'dark';
document.body.setAttribute('data-theme', savedTheme);

themeToggle?.addEventListener('click', (e) => {
  const newTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';

  // Get button center coordinates for the circle origin
  const rect = themeToggle.getBoundingClientRect();
  const x = rect.left + rect.width / 2;
  const y = rect.top + rect.height / 2;
  // Radius needs to cover the whole viewport from that point
  const maxDist = Math.hypot(
    Math.max(x, window.innerWidth - x),
    Math.max(y, window.innerHeight - y)
  );

  // Use View Transitions API if supported, otherwise fallback
  if (document.startViewTransition) {
    document.documentElement.style.setProperty('--tx', `${x}px`);
    document.documentElement.style.setProperty('--ty', `${y}px`);
    document.documentElement.style.setProperty('--tr', `${maxDist}px`);

    const transition = document.startViewTransition(() => {
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    });
  } else {
    // Fallback: use an overlay with clip-path animation
    const overlay = document.createElement('div');
    overlay.className = 'theme-transition-overlay';
    const targetBg = newTheme === 'light' ? '#f1f5f9' : '#080c14';
    overlay.style.background = targetBg;
    overlay.style.setProperty('--tx', `${x}px`);
    overlay.style.setProperty('--ty', `${y}px`);
    overlay.style.setProperty('--tr', `${maxDist}px`);
    document.body.appendChild(overlay);

    // Trigger animation
    requestAnimationFrame(() => {
      overlay.classList.add('expanding');
    });

    // Switch theme mid-animation, then remove overlay
    setTimeout(() => {
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }, 350);
    setTimeout(() => {
      overlay.remove();
    }, 700);
  }
});

// Scroll-based nav hide/show
let lastScroll = 0;
const nav = document.querySelector('.nav');
const navLogo = document.querySelector('.nav-logo');

navLogo?.addEventListener('click', (e) => {
  e.preventDefault();
  window.location.reload();
});

window.addEventListener('scroll', () => {
  const currentScroll = window.pageYOffset;
  if (currentScroll > 100) {
    nav?.classList.add(currentScroll > lastScroll ? 'scrolled-down' : 'scrolled-up');
  } else {
    nav?.classList.remove('scrolled-down', 'scrolled-up');
  }
  lastScroll = currentScroll;
});

// Back to top
const backToTop = document.querySelector('.back-to-top');
window.addEventListener('scroll', () => {
  if (backToTop) {
    backToTop.classList.toggle('visible', window.scrollY > 400);
  }
});
backToTop?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

// Copy email + toast
const toast = document.getElementById('toast');
function showToast(msg) {
  if (!toast) return;
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}
document.querySelectorAll('.contact-copy').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const value = e.currentTarget.dataset.copy;
    if (!value) return;
    try {
      await navigator.clipboard.writeText(value);
      const toasts = I18N[currentLanguage].toasts;
      showToast(value.includes('@') ? toasts.emailCopied : toasts.phoneCopied);
    } catch {
      showToast(I18N[currentLanguage].toasts.copyFailed);
    }
  });
});

// Project modal
const projectModal = document.getElementById('project-modal');
const modalContent = document.getElementById('modal-content');
const modalClose = document.querySelector('.modal-close');

document.querySelectorAll('.project-expand').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const card = e.target.closest('.project-card');
    const id = card?.dataset.project;
    if (!id || !I18N[currentLanguage]?.projects?.data?.[id]) return;
    activeProjectId = id;
    renderProjectModal(id);
    projectModal?.classList.add('open');
    document.body.style.overflow = 'hidden';
  });
});

function closeModal() {
  activeProjectId = null;
  projectModal?.classList.remove('open');
  document.body.style.overflow = '';
}
modalClose?.addEventListener('click', closeModal);
projectModal?.addEventListener('click', (e) => { if (e.target === projectModal) closeModal(); });

// Keyboard shortcuts
const shortcutsModal = document.getElementById('shortcuts-modal');
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    shortcutsModal?.classList.remove('open');
    document.body.style.overflow = '';
  }
  if (e.key === '?' && !e.ctrlKey && !e.metaKey && !e.altKey) {
    e.preventDefault();
    const isOpen = shortcutsModal?.classList.toggle('open');
    document.body.style.overflow = isOpen ? 'hidden' : '';
  }
  if (e.key >= '1' && e.key <= '5' && !e.ctrlKey && !e.metaKey) {
    const sections = ['#about', '#now', '#skills', '#experience', '#projects'];
    const idx = parseInt(e.key, 10) - 1;
    document.querySelector(sections[idx])?.scrollIntoView({ behavior: 'smooth' });
  }
});

// Intersection Observer for reveal animations
const reveals = document.querySelectorAll('.hero-badge, .hero-title, .hero-desc, .hero-actions, .about-content, .about-visual, .skill-group, .timeline-item, .project-card, .contact-intro, .contact-links, .now-card, .hero-visual, .contact-visual');
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) entry.target.classList.add('visible');
  });
}, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });
reveals.forEach(el => { el.classList.add('reveal'); observer.observe(el); });

// Mobile nav toggle
const toggle = document.querySelector('.nav-toggle');
toggle?.addEventListener('click', () => nav?.classList.toggle('active'));
document.querySelectorAll('.nav-links a').forEach(link => {
  link.addEventListener('click', () => nav?.classList.remove('active'));
});

// Contact Terminal Form
const contactForm = document.getElementById('contact-form');
const formResponse = document.getElementById('form-response');
const formError = document.getElementById('form-error');
const PENDING_MESSAGES_KEY = 'jy_pending_messages';

function readPendingMessages() {
  try {
    const raw = localStorage.getItem(PENDING_MESSAGES_KEY);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}

function writePendingMessages(list) {
  localStorage.setItem(PENDING_MESSAGES_KEY, JSON.stringify(list));
}

function enqueuePendingMessage(payload) {
  const queue = readPendingMessages();
  queue.push({
    ...payload,
    savedAt: new Date().toISOString(),
  });
  writePendingMessages(queue.slice(-50));
}

async function flushPendingMessages() {
  const queue = readPendingMessages();
  if (!queue.length) return;

  const remaining = [];
  for (const item of queue) {
    try {
      const res = await fetch('/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: item.name,
          email: item.email,
          message: item.message,
        }),
      });
      const result = await res.json().catch(() => null);
      if (!res.ok || !result?.success) {
        remaining.push(item);
      }
    } catch {
      remaining.push(item);
    }
  }

  writePendingMessages(remaining);
}

function openMailFallback(payload) {
  const subject = encodeURIComponent(`Portfolio contact from ${payload.name || 'Visitor'}`);
  const body = encodeURIComponent(
    `Name: ${payload.name || ''}\nEmail: ${payload.email || ''}\n\nMessage:\n${payload.message || ''}`
  );
  window.location.href = `mailto:jassemyounsi01@gmail.com?subject=${subject}&body=${body}`;
}

flushPendingMessages();

contactForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(contactForm);
  const body = {
    name: formData.get('name'),
    email: formData.get('email'),
    message: formData.get('message'),
  };
  try {
    const res = await fetch('/api/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const result = await res.json().catch(() => null);
    if (!res.ok || !result || result.success !== true) {
      if (result?.storagePaused) {
        enqueuePendingMessage(body);
        openMailFallback(body);
      }
      throw new Error('Server error');
    }
    contactForm.reset();
    if (formResponse) {
      formResponse.style.display = 'block';
      setTimeout(() => { formResponse.style.display = 'none'; }, 5000);
    }
  } catch (err) {
    if (formError) {
      formError.style.display = 'block';
      setTimeout(() => { formError.style.display = 'none'; }, 5000);
    }
  }
});

// Visitor/session tracking for private dashboard analytics
(function initVisitorTracking() {
  const startAt = Date.now();
  let sessionId = null;
  let sentEnd = false;
  let pendingEnd = false;

  function getDurationSeconds() {
    return Math.max(1, Math.round((Date.now() - startAt) / 1000));
  }

  function postTracking(endpoint, payload, useBeacon = false) {
    const body = JSON.stringify(payload);

    if (useBeacon && navigator.sendBeacon) {
      const blob = new Blob([body], { type: 'application/json' });
      navigator.sendBeacon(endpoint, blob);
      return;
    }

    fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body,
      keepalive: true,
    }).catch(() => {});
  }

  function sendSessionPing() {
    if (!sessionId || sentEnd) return;
    postTracking('/api/track/ping', {
      sessionId,
      durationSeconds: getDurationSeconds(),
    }, document.visibilityState === 'hidden');
  }

  fetch('/api/track/start', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ page: window.location.pathname }),
  })
    .then((response) => response.json())
    .then((data) => {
      if (data?.sessionId) {
        sessionId = data.sessionId;
        if (pendingEnd) {
          sendSessionEnd(true);
        }
      }
    })
    .catch(() => {
      // Silent fail: portfolio should still work even if tracking fails
    });

  function sendSessionEnd(force = false) {
    if (sentEnd) return;
    if (!sessionId) {
      if (force) {
        pendingEnd = true;
      }
      return;
    }
    sentEnd = true;
    postTracking('/api/track/end', {
      sessionId,
      durationSeconds: getDurationSeconds(),
    }, true);
  }

  const pingInterval = setInterval(() => {
    if (document.visibilityState === 'visible') {
      sendSessionPing();
    }
  }, 45000);

  window.addEventListener('pagehide', () => {
    clearInterval(pingInterval);
    sendSessionEnd(true);
  });
  window.addEventListener('beforeunload', () => {
    clearInterval(pingInterval);
    sendSessionEnd(true);
  });
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      sendSessionPing();
    }
  });
})();
